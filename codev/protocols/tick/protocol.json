{
  "$schema": "../../protocol-schema.json",
  "name": "tick",
  "version": "1.1.0",
  "description": "Amendment workflow for existing SPIR specifications",
  "input": {
    "type": "spec",
    "required": false
  },
  "phases": [
    {
      "id": "identify",
      "name": "Identify Target",
      "description": "Find the existing spec to amend",
      "type": "once",
      "steps": [
        "analyze_requirements",
        "find_target_spec",
        "verify_spec_integrated",
        "determine_tick_number"
      ],
      "transition": {
        "on_complete": "amend_spec"
      }
    },
    {
      "id": "amend_spec",
      "name": "Amend Specification",
      "description": "Update the existing specification",
      "type": "once",
      "steps": [
        "analyze_changes_needed",
        "update_spec_sections",
        "add_amendment_entry",
        "commit_spec_changes"
      ],
      "transition": {
        "on_complete": "amend_plan"
      }
    },
    {
      "id": "amend_plan",
      "name": "Amend Plan",
      "description": "Update the existing plan",
      "type": "once",
      "steps": [
        "update_plan_phases",
        "add_amendment_history",
        "commit_plan_changes"
      ],
      "transition": {
        "on_complete": "implement"
      }
    },
    {
      "id": "implement",
      "name": "Implement",
      "description": "Implement the amendment",
      "type": "once",
      "steps": [
        "implement_changes",
        "self_review",
        "commit"
      ],
      "checks": {
        "build": {
          "command": "npm run build",
          "on_fail": "retry",
          "max_retries": 2
        }
      },
      "transition": {
        "on_complete": "defend"
      }
    },
    {
      "id": "defend",
      "name": "Defend",
      "description": "Test the amendment",
      "type": "once",
      "steps": [
        "write_tests",
        "run_tests",
        "fix_failures"
      ],
      "checks": {
        "tests": {
          "command": "npm test",
          "on_fail": "implement",
          "max_retries": 1
        }
      },
      "transition": {
        "on_complete": "evaluate"
      }
    },
    {
      "id": "evaluate",
      "name": "Evaluate",
      "description": "Verify amendment meets requirements",
      "type": "once",
      "steps": [
        "verify_requirements",
        "check_regressions"
      ],
      "transition": {
        "on_complete": "review"
      }
    },
    {
      "id": "review",
      "name": "Review",
      "description": "Create review document and PR",
      "type": "once",
      "steps": [
        "create_tick_review",
        "create_pr"
      ],
      "consultation": {
        "on": "review",
        "models": ["gemini", "codex"],
        "type": "impl-review",
        "parallel": true,
        "max_rounds": 1
      },
      "gate": {
        "name": "pr-ready",
        "description": "Amendment ready for PR",
        "requires": ["tests_pass", "review_complete"],
        "next": null
      }
    }
  ],
  "signals": {
    "PHASE_COMPLETE": {
      "description": "Signal current phase is complete",
      "transitions_to": "next_phase"
    },
    "BLOCKED": {
      "description": "Signal implementation is blocked",
      "requires": "reason"
    }
  },
  "defaults": {
    "mode": "soft",
    "consultation": {
      "enabled": true,
      "models": ["gemini", "codex"],
      "parallel": true
    },
    "checks": {
      "build": "npm run build",
      "test": "npm test"
    }
  }
}
